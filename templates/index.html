{% extends "base.html" %}
{% block title %}Home • E‑Ink Frame{% endblock %}

{% block content %}
<h1>Library</h1>
<div class="row">
  
  <div class="current">    
    <div class="current-image">
      <img src="/static/current.jpg" alt="Current Image"><br/>
      <span>Current Image</span>
    </div>
  </div>
</div>

<div class="grid">
  {% for i in images %}
  <div class="card {{ '' if i.enabled else 'is-disabled' }}" id="img-{{ i.id }}">
    <img src="/static/thumbs/{{ i.filename }}" alt="" style="width:100%;border-radius:8px">
    <div class="row" style="justify-content:space-between;margin-top:.5rem">
      <div class="label">{{ i.title or i.original_name }}</div>
      <span class="badge">{{ 'On' if i.enabled else 'Off' }}</span>
    </div>
    <div class="row" style="margin-top:.5rem">
      <button
        class="toggle-enabled"
        data-id="{{ i.id }}"
        aria-pressed="{{ 'true' if i.enabled else 'false' }}">
        {{ 'Disable' if i.enabled else 'Enable' }}
      </button>
      <button class="show-now" data-id="{{ i.id }}">Show now</button>
      <form method="post" action="/image/{{i.id}}/delete" onsubmit="return confirm('Delete image?')"><button>Delete</button></form>
    </div>
  </div>
  {% endfor %}
</div>

<script>
  document.addEventListener('click', async (e) => {
  // SHOW NOW
  const showBtn = e.target.closest('.show-now');
  if (showBtn) {
    e.preventDefault();
    const id = showBtn.dataset.id;
    try {
      const res = await fetch(`/show-now/${id}`, { method: 'POST' });
      if (!res.ok) throw new Error('Bad response');
      // If you have a preview <img id="currentPreview" src="/static/current.jpg">
      const img = document.querySelector('#currentPreview');
      if (img) img.src = `/static/current.jpg?ts=${Date.now()}`; // bust cache
    } catch (err) {
      alert('Failed to show image now.');
      console.error(err);
    }
    return;
  }

  // TOGGLE ENABLED
  const toggleBtn = e.target.closest('.toggle-enabled');
  if (toggleBtn) {
    e.preventDefault();
    const id = toggleBtn.dataset.id;
    try {
      const res = await fetch(`/image/${id}/toggle`, { method: 'POST' });
      if (!res.ok) throw new Error('Bad response');
      const data = await res.json(); // { enabled: true|false }

      // Update button label and aria-pressed
      toggleBtn.textContent = data.enabled ? 'Disable' : 'Enable';
      toggleBtn.setAttribute('aria-pressed', data.enabled ? 'true' : 'false');

      // Optional: visually mark disabled cards
      const card = document.getElementById(`img-${id}`);
      if (card) card.classList.toggle('is-disabled', !data.enabled);
    } catch (err) {
      alert('Failed to toggle image.');
      console.error(err);
    }
  }
});
</script>
{% endblock %}
