{% extends "base.html" %}
{% block title %}Home • E‑Ink Frame{% endblock %}

{% block content %}
<h1>Library</h1>
<div class="row">
  
  <div class="current">    
    <div class="current-image">
      <img src="/static/current.jpg" alt="Current Image"><br/>
      <span>Current Image</span>
    </div>
  </div>
</div>

<div class="grid">
  {% for image in images %}
    {% include 'partials/_image_card.html' %}
  {% endfor %}
</div>

<script>
  document.addEventListener('click', async (e) => {
  // EDIT IMAGE
  const editBtn = e.target.closest('.edit-image');
  if (editBtn) {
    e.preventDefault();
    const id = editBtn.dataset.id;
    
    // Hide display elements and show edit elements
    document.getElementById(`title-display-${id}`).style.display = 'none';
    const descDisplay = document.getElementById(`desc-display-${id}`);
    if (descDisplay) descDisplay.style.display = 'none';
    document.getElementById(`title-edit-${id}`).style.display = 'block';
    
    return;
  }

  // SAVE EDIT
  const saveBtn = e.target.closest('.save-edit');
  if (saveBtn) {
    e.preventDefault();
    const id = saveBtn.dataset.id;
    const title = document.getElementById(`title-input-${id}`).value;
    const description = document.getElementById(`desc-input-${id}`).value;
    
    try {
      const formData = new FormData();
      formData.append('title', title);
      formData.append('description', description);
      
      const res = await fetch(`/image/${id}/update`, { 
        method: 'POST',
        body: formData
      });
      if (!res.ok) throw new Error('Bad response');
      
      // Update display elements
      document.getElementById(`title-display-${id}`).textContent = title;
      
      // Update or create description display
      let descDisplay = document.getElementById(`desc-display-${id}`);
      if (description.trim()) {
        if (!descDisplay) {
          descDisplay = document.createElement('div');
          descDisplay.className = 'description';
          descDisplay.id = `desc-display-${id}`;
          document.getElementById(`title-display-${id}`).parentNode.appendChild(descDisplay);
        }
        descDisplay.textContent = description;
        descDisplay.style.display = 'block';
      } else if (descDisplay) {
        descDisplay.style.display = 'none';
      }
      
      // Hide edit elements and show display elements
      document.getElementById(`title-edit-${id}`).style.display = 'none';
      document.getElementById(`title-display-${id}`).style.display = 'block';
      
    } catch (err) {
      alert('Failed to update image.');
      console.error(err);
    }
    return;
  }

  // CANCEL EDIT
  const cancelBtn = e.target.closest('.cancel-edit');
  if (cancelBtn) {
    e.preventDefault();
    const id = cancelBtn.dataset.id;
    
    // Hide edit elements and show display elements
    document.getElementById(`title-edit-${id}`).style.display = 'none';
    document.getElementById(`title-display-${id}`).style.display = 'block';
    const descDisplay = document.getElementById(`desc-display-${id}`);
    if (descDisplay) descDisplay.style.display = 'block';
    
    return;
  }

  // SHOW NOW
  const showBtn = e.target.closest('.show-now');
  if (showBtn) {
    e.preventDefault();
    const id = showBtn.dataset.id;
    try {
      const res = await fetch(`/show-now/${id}`, { method: 'POST' });
      if (!res.ok) throw new Error('Bad response');
      // If you have a preview <img id="currentPreview" src="/static/current.jpg">
      const img = document.querySelector('#currentPreview');
      if (img) img.src = `/static/current.jpg?ts=${Date.now()}`; // bust cache
    } catch (err) {
      alert('Failed to show image now.');
      console.error(err);
    }
    return;
  }

  // TOGGLE ENABLED
  const toggleBtn = e.target.closest('.toggle-enabled');
  if (toggleBtn) {
    e.preventDefault();
    const id = toggleBtn.dataset.id;
    try {
      const res = await fetch(`/image/${id}/toggle`, { method: 'POST' });
      if (!res.ok) throw new Error('Bad response');
      const data = await res.json(); // { enabled: true|false }

      // Update button label and aria-pressed
      toggleBtn.textContent = data.enabled ? 'Disable' : 'Enable';
      toggleBtn.setAttribute('aria-pressed', data.enabled ? 'true' : 'false');

      // Optional: visually mark disabled cards
      const card = document.getElementById(`img-${id}`);
      if (card) card.classList.toggle('is-disabled', !data.enabled);
    } catch (err) {
      alert('Failed to toggle image.');
      console.error(err);
    }
  }
});
</script>
{% endblock %}
