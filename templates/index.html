{% extends "base.html" %}
{% block title %}Home • E‑Ink Frame{% endblock %}

{% block content %}
<h1>Library</h1>
<div class="row">
  
  <div class="current">    
    <div class="current-image">
      <img src="/static/current.jpg" alt="Current Image"><br/>
      <span>Current Image</span>
    </div>
  </div>
</div>

<div class="grid">
  {% for image in images %}
    {% include 'partials/_image_card.html' %}
  {% endfor %}
</div>

<script>
  document.addEventListener('click', async (e) => {
  // EDIT IMAGE
  const editBtn = e.target.closest('.edit-image');
  if (editBtn) {
    e.preventDefault();
    const id = editBtn.dataset.id;
    
    // Hide display elements and show edit elements
    document.getElementById(`title-display-${id}`).style.display = 'none';
    const descDisplay = document.getElementById(`desc-display-${id}`);
    if (descDisplay) descDisplay.style.display = 'none';
    document.getElementById(`title-edit-${id}`).style.display = 'block';
    
    // Initialize crop preview
    updateCropPreview(id);
    
    return;
  }

  // SAVE EDIT
  const saveBtn = e.target.closest('.save-edit');
  if (saveBtn) {
    e.preventDefault();
    const id = saveBtn.dataset.id;
    const title = document.getElementById(`title-input-${id}`).value;
    const description = document.getElementById(`desc-input-${id}`).value;
    const cropX = document.getElementById(`crop-x-${id}`).value;
    const cropY = document.getElementById(`crop-y-${id}`).value;
    const cropWidth = document.getElementById(`crop-width-${id}`).value;
    const cropHeight = document.getElementById(`crop-height-${id}`).value;
    
    try {
      const formData = new FormData();
      formData.append('title', title);
      formData.append('description', description);
      formData.append('crop_x', cropX);
      formData.append('crop_y', cropY);
      formData.append('crop_width', cropWidth);
      formData.append('crop_height', cropHeight);
      
      const res = await fetch(`/image/${id}/update`, { 
        method: 'POST',
        body: formData
      });
      if (!res.ok) throw new Error('Bad response');
      
      // Update display elements
      document.getElementById(`title-display-${id}`).textContent = title;
      
      // Update or create description display
      let descDisplay = document.getElementById(`desc-display-${id}`);
      if (description.trim()) {
        if (!descDisplay) {
          descDisplay = document.createElement('div');
          descDisplay.className = 'description';
          descDisplay.id = `desc-display-${id}`;
          document.getElementById(`title-display-${id}`).parentNode.appendChild(descDisplay);
        }
        descDisplay.textContent = description;
        descDisplay.style.display = 'block';
      } else if (descDisplay) {
        descDisplay.style.display = 'none';
      }
      
      // Hide edit elements and show display elements
      document.getElementById(`title-edit-${id}`).style.display = 'none';
      document.getElementById(`title-display-${id}`).style.display = 'block';
      
    } catch (err) {
      alert('Failed to update image.');
      console.error(err);
    }
    return;
  }

  // CANCEL EDIT
  const cancelBtn = e.target.closest('.cancel-edit');
  if (cancelBtn) {
    e.preventDefault();
    const id = cancelBtn.dataset.id;
    
    // Hide edit elements and show display elements
    document.getElementById(`title-edit-${id}`).style.display = 'none';
    document.getElementById(`title-display-${id}`).style.display = 'block';
    const descDisplay = document.getElementById(`desc-display-${id}`);
    if (descDisplay) descDisplay.style.display = 'block';
    
    return;
  }

  // SHOW NOW
  const showBtn = e.target.closest('.show-now');
  if (showBtn) {
    e.preventDefault();
    const id = showBtn.dataset.id;
    try {
      const res = await fetch(`/show-now/${id}`, { method: 'POST' });
      if (!res.ok) throw new Error('Bad response');
      // If you have a preview <img id="currentPreview" src="/static/current.jpg">
      const img = document.querySelector('#currentPreview');
      if (img) img.src = `/static/current.jpg?ts=${Date.now()}`; // bust cache
    } catch (err) {
      alert('Failed to show image now.');
      console.error(err);
    }
    return;
  }

  // TOGGLE ENABLED
  const toggleBtn = e.target.closest('.toggle-enabled');
  if (toggleBtn) {
    e.preventDefault();
    const id = toggleBtn.dataset.id;
    try {
      const res = await fetch(`/image/${id}/toggle`, { method: 'POST' });
      if (!res.ok) throw new Error('Bad response');
      const data = await res.json(); // { enabled: true|false }

      // Update button label and aria-pressed
      toggleBtn.textContent = data.enabled ? 'Disable' : 'Enable';
      toggleBtn.setAttribute('aria-pressed', data.enabled ? 'true' : 'false');

      // Optional: visually mark disabled cards
      const card = document.getElementById(`img-${id}`);
      if (card) card.classList.toggle('is-disabled', !data.enabled);
    } catch (err) {
      alert('Failed to toggle image.');
      console.error(err);
    }
  }
});

// Crop preview functions
function updateCropPreview(id) {
  const img = document.getElementById(`crop-preview-${id}`);
  const overlay = document.getElementById(`crop-overlay-${id}`);
  const cropX = parseInt(document.getElementById(`crop-x-${id}`).value);
  const cropY = parseInt(document.getElementById(`crop-y-${id}`).value);
  const cropWidth = parseInt(document.getElementById(`crop-width-${id}`).value);
  const cropHeight = parseInt(document.getElementById(`crop-height-${id}`).value);
  
  if (img && overlay) {
    const imgRect = img.getBoundingClientRect();
    const containerRect = img.parentElement.getBoundingClientRect();
    
    const left = (cropX / 100) * img.offsetWidth;
    const top = (cropY / 100) * img.offsetHeight;
    const width = (cropWidth / 100) * img.offsetWidth;
    const height = (cropHeight / 100) * img.offsetHeight;
    
    overlay.style.left = left + 'px';
    overlay.style.top = top + 'px';
    overlay.style.width = width + 'px';
    overlay.style.height = height + 'px';
  }
  
  // Update value displays
  document.getElementById(`crop-x-val-${id}`).textContent = cropX + '%';
  document.getElementById(`crop-y-val-${id}`).textContent = cropY + '%';
  document.getElementById(`crop-width-val-${id}`).textContent = cropWidth + '%';
  document.getElementById(`crop-height-val-${id}`).textContent = cropHeight + '%';
}

// Event listeners for crop sliders
document.addEventListener('input', (e) => {
  if (e.target.type === 'range' && e.target.id.includes('crop-')) {
    const id = e.target.id.split('-').slice(-1)[0];
    updateCropPreview(id);
  }
});
</script>
{% endblock %}
