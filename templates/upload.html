{% extends "base.html" %}
{% block title %}Upload Images • E‑Ink Frame{% endblock %}

{% block content %}
<h1>Upload Images</h1>
<form id="uploadForm" enctype="multipart/form-data">
  <div>
    <label>
      <span>Select Images</span>
      <input type="file" name="files" accept="image/*" multiple required>
      <small>Hold Ctrl (or Cmd on Mac) to select multiple images</small>
    </label>
  </div>
  <button type="submit" id="uploadBtn">Upload Images</button>
  
  <div id="uploadProgress" style="display: none;">
    <div id="progressText">Uploading images...</div>
    <div id="progressBar" style="width: 100%; background: #333; border-radius: 4px; margin-top: 0.5rem;">
      <div id="progressFill" style="width: 0%; height: 20px; background: #0066cc; border-radius: 4px; transition: width 0.3s;"></div>
    </div>
    <div id="progressDetails" style="margin-top: 0.5rem; font-size: 0.9rem; color: #ccc;"></div>
  </div>
  
  <div id="uploadComplete" style="display: none;">
    <div style="color: #28a745; font-weight: bold; margin-top: 1rem;">Upload completed!</div>
    <button onclick="goToGallery()" style="margin-top: 0.5rem;">Go to Gallery</button>
  </div>
  
  <div id="uploadErrors" style="display: none; margin-top: 1rem;">
    <div style="color: #dc3545; font-weight: bold;">Some uploads failed:</div>
    <ul id="errorList" style="color: #dc3545; margin-top: 0.5rem;"></ul>
  </div>
</form>

<script>
let currentTaskId = null;
let statusInterval = null;
let isUploading = false; // Prevent double submissions

document.getElementById('uploadForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  // Prevent double submissions
  if (isUploading) {
    console.log('Upload already in progress, ignoring submission');
    return;
  }
  
  const fileInput = document.querySelector('input[type="file"]');
  const files = fileInput.files;
  
  if (files.length === 0) {
    alert('Please select at least one image to upload.');
    return;
  }
  
  if (files.length > 20) {
    if (!confirm(`You've selected ${files.length} images. This might take a while. Continue?`)) {
      return;
    }
  }
  
  // Set uploading flag and update UI
  isUploading = true;
  
  // Reset UI
  document.getElementById('uploadProgress').style.display = 'block';
  document.getElementById('uploadComplete').style.display = 'none';
  document.getElementById('uploadErrors').style.display = 'none';
  
  const submitBtn = document.getElementById('uploadBtn');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Starting upload...';
  
  try {
    // Create FormData and submit
    const formData = new FormData();
    for (let file of files) {
      formData.append('files', file);
    }
    
    const response = await fetch('/upload', {
      method: 'POST',
      body: formData
    });
    
    const result = await response.json();
    
    if (!response.ok) {
      throw new Error(result.error || 'Upload failed');
    }
    
    currentTaskId = result.task_id;
    document.getElementById('progressText').textContent = `Upload queued (${files.length} files)`;
    
    // Start polling for status
    statusInterval = setInterval(checkUploadStatus, 500);
    
  } catch (error) {
    console.error('Upload error:', error);
    document.getElementById('progressText').textContent = 'Upload failed: ' + error.message;
    submitBtn.disabled = false;
    submitBtn.textContent = 'Upload Images';
    isUploading = false; // Reset upload flag on error
  }
});

async function checkUploadStatus() {
  if (!currentTaskId) return;
  
  try {
    const response = await fetch(`/upload/status/${currentTaskId}`);
    const status = await response.json();
    
    if (!response.ok) {
      throw new Error('Failed to get upload status');
    }
    
    // Update progress
    const progress = status.total > 0 ? (status.progress / status.total) * 100 : 0;
    document.getElementById('progressFill').style.width = progress + '%';
    
    // Update text
    if (status.status === 'queued') {
      document.getElementById('progressText').textContent = 'Upload queued...';
    } else if (status.status === 'processing') {
      document.getElementById('progressText').textContent = `Processing images...`;
      document.getElementById('progressDetails').textContent = 
        `${status.uploaded} of ${status.total} images processed`;
    } else if (status.status === 'completed') {
      // Upload finished
      clearInterval(statusInterval);
      document.getElementById('progressText').textContent = 'Upload completed!';
      document.getElementById('progressDetails').textContent = 
        `Successfully uploaded ${status.uploaded} of ${status.total} images`;
      document.getElementById('uploadComplete').style.display = 'block';
      
      // Show errors if any
      if (status.errors && status.errors.length > 0) {
        showErrors(status.errors);
      }
      
      // Reset button and upload flag
      const submitBtn = document.getElementById('uploadBtn');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Upload Images';
      isUploading = false; // Reset upload flag on completion
      
    } else if (status.status === 'error') {
      // Upload failed
      clearInterval(statusInterval);
      document.getElementById('progressText').textContent = 'Upload failed';
      showErrors(status.errors || ['Unknown error occurred']);
      
      const submitBtn = document.getElementById('uploadBtn');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Upload Images';
      isUploading = false; // Reset upload flag on error
    }
    
  } catch (error) {
    console.error('Status check error:', error);
    clearInterval(statusInterval);
    document.getElementById('progressText').textContent = 'Error checking upload status';
  }
}

function showErrors(errors) {
  const errorDiv = document.getElementById('uploadErrors');
  const errorList = document.getElementById('errorList');
  errorList.innerHTML = '';
  
  errors.forEach(error => {
    const li = document.createElement('li');
    li.textContent = error;
    errorList.appendChild(li);
  });
  
  errorDiv.style.display = 'block';
}

// Show file count when files are selected
document.querySelector('input[type="file"]').addEventListener('change', function(e) {
  const count = e.target.files.length;
  const existing = document.getElementById('fileCount');
  if (existing) existing.remove();
  
  if (count > 0) {
    const div = document.createElement('div');
    div.id = 'fileCount';
    div.style.cssText = 'color: #0066cc; font-weight: bold; margin-top: 0.5rem;';
    div.textContent = `${count} image${count === 1 ? '' : 's'} selected`;
    e.target.parentNode.appendChild(div);
  }
});

function goToGallery() {
  console.log('[UPLOAD] Go to Gallery button clicked - cleaning up state');
  
  // Clear any remaining intervals
  if (statusInterval) {
    clearInterval(statusInterval);
    statusInterval = null;
  }
  
  // Reset all state
  currentTaskId = null;
  isUploading = false;
  
  // Clear form
  document.getElementById('uploadForm').reset();
  
  // Hide all progress/status elements
  document.getElementById('uploadProgress').style.display = 'none';
  document.getElementById('uploadComplete').style.display = 'none';
  document.getElementById('uploadErrors').style.display = 'none';
  
  // Reset button state
  const submitBtn = document.getElementById('uploadBtn');
  submitBtn.disabled = false;
  submitBtn.textContent = 'Upload Images';
  
  console.log('[UPLOAD] State cleared, navigating to gallery');
  
  // Navigate to gallery
  window.location.href = '/';
}
</script>

<style>
  label {
    display: block;
    margin-bottom: 1rem;
  }
  label span {
    display: block;
    font-weight: bold;
    margin-bottom: 0.25rem;
  }
  input[type="file"] {
    width: 100%;
    padding: 0.5rem;
    border: 2px dashed #666;
    border-radius: 4px;
    background: #222;
    color: #eee;
  }
  input[type="text"], textarea {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #666;
    border-radius: 4px;
    background: #222;
    color: #eee;
  }
  small {
    display: block;
    color: #999;
    font-size: 0.8rem;
    margin-top: 0.25rem;
  }
  button {
    background: #0066cc;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
  }
  button:hover {
    background: #0052a3;
  }
  button:disabled {
    background: #666;
    cursor: not-allowed;
  }
</style>
{% endblock %}
